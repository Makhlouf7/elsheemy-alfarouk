<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>فاتورة عميل</title>
    <link rel="stylesheet" href="./print-styles.css" />
    <style>
      body {
        font-family: 'Arial', sans-serif;
        margin: 0;
        padding: 20px;
        background-color: white;
        color: black;
        direction: rtl;
      }
      
      .print-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        background-color: white;
      }
      
      .invoice-title {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin: 20px 0;
        color: #007bff;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      
      .invoice-number {
        text-align: left;
        font-size: 14px;
        margin: 10px 0;
      }
      
      .customer-details {
        border: 1px solid #000;
        padding: 15px;
        margin: 20px 0;
        background-color: #f9f9f9;
        border-radius: 5px;
      }
      
      .customer-details h3 {
        margin-top: 0;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
        color: #007bff;
      }
      
      .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      
      .detail-item {
        margin: 5px 0;
      }
      
      .detail-label {
        font-weight: bold;
        color: #555;
      }
      
      .detail-value {
        font-weight: bold;
        color: #007bff;
      }
      
      .invoice-table {
        width: 100%;
        border: 2px solid #000;
        margin: 20px 0;
        border-collapse: collapse;
      }
      
      .invoice-table th {
        background-color: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
        border: 1px solid #000;
      }
      
      .invoice-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #000;
      }
      
      .invoice-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      
      .invoice-total {
        text-align: left;
        margin: 20px 0;
        font-size: 18px;
        font-weight: bold;
      }
      
      .total-box {
        border: 2px solid #000;
        display: inline-block;
        padding: 10px 20px;
        background-color: #f9f9f9;
      }
      
      .total-in-words {
        margin-top: 10px;
        font-size: 14px;
        border-top: 1px dashed #ccc;
        padding-top: 10px;
      }
      
      .print-actions {
        margin: 20px 0;
        text-align: center;
      }
      
      .print-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      
      .print-btn:hover {
        background-color: #0056b3;
      }
      
      @media print {
        .print-actions {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="print-container">
      <!-- Print Actions (only visible on screen) -->
      <div class="print-actions">
        <button class="print-btn" onclick="window.print()">طباعة الفاتورة</button>
      </div>
      
      <!-- Header with company logo and info -->
      <div class="print-header">
        <div class="company-logo-container">
          <div class="company-logo">
            <div class="logo-oval">
              <!-- Oval background with text -->
              <div style="position: absolute; width: 90%; height: 60%; top: 20%; left: 5%; border: 2px solid #000; border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center; transform: rotate(-10deg);">
                <span style="font-weight: bold; font-size: 14px; text-align: center; transform: rotate(10deg);">ELSHEEMY</span>
                <span style="font-weight: bold; font-size: 14px; text-align: center; transform: rotate(10deg);">STEEL</span>
              </div>
              <!-- Top star -->
              <div style="position: absolute; top: 5%; left: 50%; transform: translateX(-50%);">★</div>
              <!-- Bottom text -->
              <div style="position: absolute; bottom: 10%; width: 100%; text-align: center;">
                <span style="font-weight: bold; font-size: 12px;">ALFAROUK</span>
              </div>
              <!-- Left star -->
              <div style="position: absolute; top: 50%; left: 5%; transform: translateY(-50%);">★</div>
              <!-- Right star -->
              <div style="position: absolute; top: 50%; right: 5%; transform: translateY(-50%);">★</div>
            </div>
          </div>
          <div class="company-info">
            <h1>مؤسســة الشيــمي و الفــاروق</h1>
            <p>لتجــارة وتوزيــع جميــع مــواد البنــاء</p>
            <p>يسري عرب عبدالرحمن الشيمي وشركاه</p>
            <p>س.ت: ٦٨٠٠٤ - ب.ض: ٧٨٤-٣٣٣٣-٦٦٢ - م.ض: ٠١-٠٢-٠٠٥-٥٨٢٢-٠</p>
            <p class="note">( الكمية المحجوزة لا ترد ولا تلغى في حالة زيادة أو نقص السعر لأي سبب من الأسباب</p>
            <p class="note">لأن الكمية محجوزة من رغبة العميل )</p>
          </div>
        </div>
      </div>
      
      <!-- Invoice Title -->
      <div class="invoice-title">فاتورة عميل</div>
      
      <!-- Invoice Number -->
      <div class="invoice-number">رقم الفاتورة: <span id="invoice-number">INV-2023-001</span></div>
      
      <!-- Customer Details -->
      <div class="customer-details">
        <h3>بيانات العميل</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="detail-label">اسم العميل:</span>
            <span class="detail-value" id="customer-name">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">التاريخ:</span>
            <span class="detail-value" id="invoice-date">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">البلد:</span>
            <span class="detail-value" id="country">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">اسم السائق:</span>
            <span class="detail-value" id="driver-name">-</span>
          </div>
        </div>
      </div>
      
      <!-- Invoice Table -->
      <table class="invoice-table">
        <thead>
          <tr>
            <th>نوع الحمولة</th>
            <th>الصنف</th>
            <th>الكمية</th>
            <th>شكاره</th>
            <th>السعر</th>
            <th>الإجمالي</th>
          </tr>
        </thead>
        <tbody id="invoice-items">
          <!-- Items will be added here dynamically -->
        </tbody>
      </table>
      
      <!-- Invoice Total -->
      <div class="invoice-total">
        <div class="total-box">
          الإجمالي: <span id="invoice-total">-</span>
        </div>
        <div class="total-in-words">
          المبلغ بالحروف: <span id="total-in-words">-</span>
        </div>
      </div>
      
      <!-- Space between total and footer -->
      <div style="margin: 50px 0;"></div>
      
      <!-- Footer -->
      <div class="print-footer">
        <p>شكراً لتعاملكم معنا</p>
        <p>للاستفسار: 01234567890</p>
        <p>تم إنشاء هذا التقرير بواسطة نظام إدارة المخزون - جميع الحقوق محفوظة &copy; 2023</p>
      </div>
    </div>
    
    <script>
      // Arabic number to words conversion
      function convertNumberToArabicWords(number) {
        const arabicOnes = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
        const arabicTens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
        const arabicHundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
        const arabicThousands = ['', 'ألف', 'ألفان', 'ثلاثة آلاف', 'أربعة آلاف', 'خمسة آلاف', 'ستة آلاف', 'سبعة آلاف', 'ثمانية آلاف', 'تسعة آلاف'];
        
        if (number === 0) return 'صفر';
        
        let words = '';
        
        // Handle thousands
        if (number >= 1000) {
          const thousands = Math.floor(number / 1000);
          if (thousands <= 10) {
            words += arabicThousands[thousands] + ' ';
          } else {
            words += convertNumberToArabicWords(thousands) + ' ألف ';
          }
          number %= 1000;
        }
        
        // Handle hundreds
        if (number >= 100) {
          const hundreds = Math.floor(number / 100);
          words += arabicHundreds[hundreds] + ' ';
          number %= 100;
        }
        
        // Handle tens and ones
        if (number > 0) {
          if (words !== '') words += 'و';
          
          if (number < 20) {
            words += arabicOnes[number] + ' ';
          } else {
            const ones = number % 10;
            const tens = Math.floor(number / 10);
            
            if (ones > 0) {
              words += arabicOnes[ones] + ' و';
            }
            
            words += arabicTens[tens] + ' ';
          }
        }
        
        return words.trim();
      }
      
      // Get URL parameters
      function getUrlParams() {
        const params = {};
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        
        for (const [key, value] of urlParams.entries()) {
          params[key] = value;
        }
        
        return params;
      }
      
      // Format number with commas
      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      
      // Fill invoice with data from URL parameters
      function fillInvoice() {
        const params = getUrlParams();
        
        // Set invoice number with current date
        const now = new Date();
        const invoiceNumber = `INV-${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
        document.getElementById('invoice-number').textContent = invoiceNumber;
        
        // Set customer details
        document.getElementById('customer-name').textContent = params.customerName || 'عميل جديد';
        document.getElementById('invoice-date').textContent = params.date || new Date().toLocaleDateString('ar-EG');
        document.getElementById('country').textContent = params.country || '-';
        document.getElementById('driver-name').textContent = params.driverName || '-';
        
        // Parse items from URL
        let items = [];
        try {
          if (params.items) {
            items = JSON.parse(decodeURIComponent(params.items));
          }
        } catch (e) {
          console.error('Error parsing items:', e);
          items = [];
        }
        
        // Add items to table
        const tbody = document.getElementById('invoice-items');
        tbody.innerHTML = '';
        
        let totalAmount = 0;
        
        if (items.length === 0) {
          // Add dummy item if no items provided
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>عز</td>
            <td>16</td>
            <td>25.00</td>
            <td>500</td>
            <td>20,000 جنيه</td>
            <td>500,000 جنيه</td>
          `;
          tbody.appendChild(row);
          totalAmount = 500000;
        } else {
          items.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // Map load type values to display names
            const loadTypeMap = {
              'az': 'عز',
              'estithmari': 'استثماري',
              'komy': 'كومي'
            };
            
            const loadTypeName = loadTypeMap[item.loadType] || item.loadType || 'عز';
            const quantity = parseFloat(item.quantity) || 0;
            const shakara = parseInt(item.shakara) || 0;
            const price = parseFloat(item.price) || 0;
            const total = parseFloat(item.total) || (quantity * price);
            
            row.innerHTML = `
              <td>${loadTypeName}</td>
              <td>${item.category || '16'}</td>
              <td>${quantity.toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
              <td>${shakara.toLocaleString('ar-EG')}</td>
              <td>${formatNumber(price)} جنيه</td>
              <td>${formatNumber(total)} جنيه</td>
            `;
            
            if (index % 2 === 1) {
              row.style.backgroundColor = '#f9f9f9';
            }
            
            tbody.appendChild(row);
            totalAmount += total;
          });
        }
        
        // Set total amount
        document.getElementById('invoice-total').textContent = `${formatNumber(totalAmount)} جنيه`;
        
        // Set total in words
        document.getElementById('total-in-words').textContent = `${convertNumberToArabicWords(Math.floor(totalAmount))} جنيه مصري فقط لا غير`;
        
        // Auto print if specified
        if (params.autoPrint === 'true') {
          setTimeout(() => {
            window.print();
            // Close window after printing (only if opened as a popup)
            if (window.opener) {
              setTimeout(() => window.close(), 500);
            }
          }, 500);
        }
      }
      
      // Run when document is loaded
      document.addEventListener('DOMContentLoaded', fillInvoice);
      
      // Print button handler
      document.querySelector('.print-btn').addEventListener('click', function() {
        window.print();
      });
    </script>
  </body>
</html>
